<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard b√°o c√°o ng√†y</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060314;

      --card:rgba(10,15,40,.96);
      --stroke:rgba(255,255,255,.10);

      --text:#E7ECFF;
      --text2:rgba(231,236,255,.86);
      --muted:rgba(231,236,255,.64);
      --muted2:rgba(231,236,255,.44);

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --c-prod: 96,165,250;   /* s·∫£n l∆∞·ª£ng */
      --c-run:  52,211,153;   /* T ch·∫°y */
      --c-ph1:  251,191,36;   /* P_H1 */
      --c-ph2:  167,139,250;  /* P_H2 */
      --c-mnh:  34,211,238;   /* MNH */
      --c-qve:  59,130,246;   /* Q v·ªÅ */
      --c-qch:  248,113,113;  /* Q ch·∫°y */
      --c-qxa:  251,191,36;   /* Q x·∫£ */

      --good:#34D399;
      --bad:#FB7185;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 20% -10%, rgba(96,165,250,.28), transparent 60%),
        radial-gradient(900px 520px at 45% 120%, rgba(52,211,153,.18), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .app{ max-width: 560px; margin:0 auto; min-height:100%; padding:12px 12px 28px; }

    .topbar{
      position:sticky; top:0; z-index:10;
      padding:10px 2px 10px;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,8,22,.85), rgba(5,8,22,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .titleRow{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:6px 6px 10px;
    }
    h1{ margin:0; font-size:17px; letter-spacing:.3px; display:flex; align-items:center; gap:8px; color:var(--text2); }
    small{ color:var(--muted); font-size:12px; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background:rgba(255,255,255,.35); box-shadow: 0 0 0 6px rgba(255,255,255,.06); }
    .dot.ok{ background:var(--good); box-shadow:0 0 0 6px rgba(52,211,153,.17); }
    .dot.err{ background:var(--bad); box-shadow:0 0 0 6px rgba(251,113,133,.17); }

    .card{
      background:var(--card);
      border-radius:var(--radius2);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-top:12px;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:linear-gradient(90deg,rgba(255,255,255,.05),rgba(255,255,255,.01));
    }
    .cardHead b{ font-size:13px; letter-spacing:.2px; color:var(--text2); }
    .cardBody{ padding:12px 14px 14px; }

    label{ font-size:12px; color:var(--muted); }
    input, select, button{
      font-family:var(--sans);
      font-size:14px;
      color:var(--text);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      padding:9px 12px;
      outline:none;
    }
    input[type="date"]{ padding:8px 12px; }
    button{
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:active{ transform:translateY(1px); }
    button.primary{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.55);
    }
    button.primary:hover{
      background:rgba(96,165,250,.26);
      border-color:rgba(96,165,250,.8);
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:end; }
    .control{ flex:1; min-width:160px; display:flex; flex-direction:column; gap:6px; }

    .hint{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.45; }
    .mono{ font-family:var(--mono); }

    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .kpi{
      padding:11px 11px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 0% 0%, rgba(255,255,255,.07), rgba(7,11,30,.98));
      min-height:76px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ margin-top:6px; font-size:18px; font-weight:800; letter-spacing:.2px; color:var(--text); }
    .kpi .sub{ margin-top:4px; font-size:11px; color:var(--muted2); }

    .noteBox{
      margin-top:10px;
      padding:11px 11px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      font-size:13px;
      color:var(--text2);
      line-height:1.45;
    }
    .noteBox .label{ font-size:12px; color:var(--muted); margin-bottom:4px; }

    .tabs{ display:flex; flex-wrap:wrap; gap:8px; }
    .tab{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:7px;
      cursor:pointer;
      user-select:none;
    }
    .swatch{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 0 0 4px rgba(255,255,255,.04);
    }
    .tab.active{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.22);
      color:var(--text2);
      font-weight:700;
    }

    canvas{ width:100% !important; height:280px !important; }

    .plantCard{
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(7,10,32,.96);
      overflow:hidden;
    }
    .plantHead{
      padding:11px 14px;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(90deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    }
    .plantHead .name{ font-weight:800; letter-spacing:.3px; color:var(--text2); }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
    }
    .metrics{
      padding:11px 14px 12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .metric{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.09);
      background:rgba(255,255,255,.03);
      padding:9px 9px;
      min-height:60px;
    }
    .metric .mLabel{ font-size:12px; color:var(--muted2); }
    .metric .mVal{ margin-top:5px; font-weight:800; color:var(--text); }

    .empty{ padding:18px 14px; font-size:13px; color:var(--muted); text-align:center; }

    .toast{
      position:fixed; left:12px; right:12px; bottom:14px;
      max-width:560px; margin:0 auto;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(6,10,34,.92);
      color:rgba(231,236,255,.92);
      font-size:13px;
      display:none;
      box-shadow:var(--shadow);
    }
    .toast.show{ display:block; }

    /* Q v·ªÅ / Q ch·∫°y / Q x·∫£ nhi·ªÅu m√†u */
    .qValueWrap{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .qItem{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
    }
    .qDot{
      width:7px; height:7px;
      border-radius:999px;
    }
    .qVe  .qDot{ background:rgba(var(--c-qve),.95); }
    .qChay .qDot{ background:rgba(var(--c-qch),.95); }
    .qXa  .qDot{ background:rgba(var(--c-qxa),.95); }
    .qVe  .qLabel{ color:rgba(var(--c-qve),.9); }
    .qChay .qLabel{ color:rgba(var(--c-qch),.9); }
    .qXa  .qLabel{ color:rgba(var(--c-qxa),.9); }
  </style>
</head>
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard b√°o c√°o ng√†y</title>

  <!-- PWA -->
  <meta name="theme-color" content="#050816" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060314;

      --card:rgba(10,15,40,.96);
      --stroke:rgba(255,255,255,.10);

      --text:#E7ECFF;
      --text2:rgba(231,236,255,.86);
      --muted:rgba(231,236,255,.64);
      --muted2:rgba(231,236,255,.44);

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --c-prod: 96,165,250;
      --c-run:  52,211,153;
      --c-ph1:  251,191,36;
      --c-ph2:  167,139,250;
      --c-mnh:  34,211,238;
      --c-qve:  59,130,246;
      --c-qch:  248,113,113;
      --c-qxa:  251,191,36;

      --good:#34D399;
      --bad:#FB7185;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 20% -10%, rgba(96,165,250,.28), transparent 60%),
        radial-gradient(900px 520px at 45% 120%, rgba(52,211,153,.18), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }

    /* (TO√ÄN B·ªò CSS C·ª¶A B·∫†N GI·ªÆ NGUY√äN) */
<body>
  <div class="app">
    <div class="topbar">
      <div class="titleRow">
        <div>
          <h1>üìä Dashboard b√°o c√°o ng√†y
            <span class="chip"><span id="dot" class="dot"></span><span id="connText">ƒêang ki·ªÉm tra‚Ä¶</span></span>
          </h1>
          <small>M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã D-1 ‚Ä¢ L≈©y k·∫ø th√°ng &amp; nƒÉm ‚Ä¢ Bi·ªÉu ƒë·ªì Q v·ªÅ + Q ch·∫°y m√°y</small>
        </div>
      </div>
    </div>

    <!-- CH·ªåN NG√ÄY -->
    <section class="card">
      <div class="cardHead">
        <b>Ch·ªçn ng√†y b√°o c√°o</b>
        <span class="chip mono" id="dateText">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="control">
            <label for="day">Ng√†y</label>
            <input id="day" type="date">
          </div>
          <div class="control">
            <label for="view">T·ªï m√°y</label>
            <select id="view">
              <option value="BOTH">H1 + H2</option>
              <option value="H1">Ch·ªâ H1</option>
              <option value="H2">Ch·ªâ H2</option>
            </select>
          </div>
          <div class="control" style="flex:0; min-width:140px;">
            <label>&nbsp;</label>
            <button id="btnLoad" class="primary" type="button">T·∫£i b√°o c√°o</button>
          </div>
        </div>
        <div class="hint">
          D·ªØ li·ªáu l·∫•y t·ª´ b·∫£ng <span class="mono">report_days</span> &amp; <span class="mono">report_units</span> tr√™n Supabase.
        </div>
      </div>
    </section>

    <!-- TH√îNG TIN CHUNG -->
    <section class="card">
      <div class="cardHead">
        <b>Th√¥ng tin t·ªïng quan</b>
        <span class="chip" id="basicTitle">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="grid3">
          <div class="kpi">
            <div class="label">S·∫£n l∆∞·ª£ng H1 (kWh)</div>
            <div class="value" id="eH1">‚Äî</div>
            <div class="sub" id="eH1Sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">S·∫£n l∆∞·ª£ng H2 (kWh)</div>
            <div class="value" id="eH2">‚Äî</div>
            <div class="sub" id="eH2Sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">T·ªïng s·∫£n l∆∞·ª£ng ng√†y (kWh)</div>
            <div class="value" id="eSum">‚Äî</div>
            <div class="sub" id="eSumSub">H1 + H2</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">L≈©y k·∫ø th√°ng (kWh)</div>
            <div class="value" id="eMonthTotal">‚Äî</div>
            <div class="sub" id="eMonthSub">H1 / H2</div>
          </div>
          <div class="kpi">
            <div class="label">L≈©y k·∫ø nƒÉm (kWh)</div>
            <div class="value" id="eYearTotal">‚Äî</div>
            <div class="sub" id="eYearSub">H1 / H2</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">MNH &amp; m·ª±c n∆∞·ªõc (m)</div>
            <div class="value" id="basicMNH">‚Äî</div>
            <div class="sub" id="basicMNHSub">M·ª±c n∆∞·ªõc h·ªì / MNH QT / NSMO</div>
          </div>
          <div class="kpi">
            <div class="label">Q (m¬≥/s)</div>
            <div class="value" id="basicQ">‚Äî</div>
            <div class="sub" id="basicQSub">Q v·ªÅ / Q ch·∫°y / Q x·∫£</div>
          </div>
        </div>

        <div class="noteBox">
          <div class="label">Ghi ch√∫ &amp; PCT</div>
          <div id="basicNote">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- TABS -->
    <section class="card">
      <div class="cardHead">
        <b>Ch·ªçn bi·ªÉu ƒë·ªì</b>
        <div class="tabs" id="metricTabs">
          <span class="tab active" data-m="energy">
            <span class="swatch" style="background:rgba(var(--c-prod),.9)"></span> S·∫£n l∆∞·ª£ng
          </span>
          <span class="tab" data-m="runtime">
            <span class="swatch" style="background:rgba(var(--c-run),.9)"></span> T ch·∫°y m√°y
          </span>
          <span class="tab" data-m="P_H1">
            <span class="swatch" style="background:rgba(var(--c-ph1),.9)"></span> P_H1
          </span>
          <span class="tab" data-m="P_H2">
            <span class="swatch" style="background:rgba(var(--c-ph2),.9)"></span> P_H2
          </span>
          <span class="tab" data-m="MNH_7D">
            <span class="swatch" style="background:rgba(var(--c-mnh),.9)"></span> MNH (D-7‚ÜíD-1)
          </span>
          <span class="tab" data-m="Q_7D">
            <span class="swatch" style="background:linear-gradient(135deg,rgba(var(--c-qve),.9),rgba(var(--c-qch),.9))"></span> Q (D-7‚ÜíD-1)
          </span>
        </div>
      </div>
      <div class="cardBody">
        <div class="hint" id="tabHint">
          M·∫∑c ƒë·ªãnh: so s√°nh S·∫£n l∆∞·ª£ng (kWh) H1 vs H2 trong ng√†y. Tab Q s·∫Ω hi·ªÉn th·ªã Q v·ªÅ + Q ch·∫°y m√°y.
        </div>
      </div>
    </section>

    <!-- CHART -->
    <section class="card">
      <div class="cardHead">
        <b>Bi·ªÉu ƒë·ªì</b>
        <span class="chip" id="metricName">S·∫£n l∆∞·ª£ng</span>
      </div>
      <div class="cardBody">
        <canvas id="chart"></canvas>
        <div class="hint" id="chartHint">‚Äî</div>
      </div>
    </section>

    <!-- CHI TI·∫æT T·ªî M√ÅY -->
    <section class="card">
      <div class="cardHead">
        <b>Chi ti·∫øt theo t·ªï m√°y</b>
        <span class="chip mono" id="noteText">Ghi ch√∫: ‚Äî</span>
      </div>
      <div class="cardBody" id="detailWrap"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // =======================
    // SUPABASE CONFIG
    // =======================
    const SUPABASE_URL = "https://upicvbecjmzkfgoawupo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaWN2YmVjam16a2Znb2F3dXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTAzMTEsImV4cCI6MjA4MDkyNjMxMX0.3pVGVnP_OjkwLCvoVQzK7xaJRUaiFzJfopzUvPsWwXE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =======================
    // HELPERS
    // =======================
    const $ = id => document.getElementById(id);
    const fmt = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 2 });
    const fmt0 = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 0 });

    const cssRGB = varName =>
      getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    const rgba = (rgb, a) => `rgba(${rgb}, ${a})`;

    function setConn(kind, text){
      $("dot").className = "dot" + (kind ? " " + kind : "");
      $("connText").textContent = text;
    }
    function toast(msg){
      $("toast").textContent = msg;
      $("toast").classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>$("toast").classList.remove("show"), 2200);
    }

    function toISO(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function addDaysISO(iso, delta){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate()+delta);
      return toISO(dt);
    }
    function getDMinus1ISO(){
      const d = new Date();
      d.setDate(d.getDate()-1);
      return toISO(d);
    }

    const tabMeta = {
      energy:  { name:"S·∫£n l∆∞·ª£ng", hint:"So s√°nh S·∫£n l∆∞·ª£ng (kWh) H1 vs H2 trong ng√†y.", color:"--c-prod" },
      runtime: { name:"T ch·∫°y m√°y", hint:"So s√°nh T ch·∫°y m√°y (h) H1 vs H2 trong ng√†y.", color:"--c-run" },
      P_H1:    { name:"P_H1", hint:"Pmin & Pmax t·ªï m√°y H1 trong ng√†y.", color:"--c-ph1" },
      P_H2:    { name:"P_H2", hint:"Pmin & Pmax t·ªï m√°y H2 trong ng√†y.", color:"--c-ph2" },
      MNH_7D:  { name:"MNH (D-7‚ÜíD-1)", hint:"Bi·ªÉu ƒë·ªì MNH (m·ª©c n∆∞·ªõc h·ªì) t·ª´ D-7 ƒë·∫øn D-1.", color:"--c-mnh" },
      Q_7D:    { name:"Q (D-7‚ÜíD-1)", hint:"Bi·ªÉu ƒë·ªì Q v·ªÅ & Q ch·∫°y m√°y (m¬≥/s) D-7 ‚Üí D-1.", color:"--c-qch" }
    };

    function metricBox(label, value){
      const n = Number(value);
      const v = (value===null || value===undefined || value==="") ? "‚Äî" :
                (Number.isFinite(n) ? fmt.format(n) : String(value));
      return `
        <div class="metric">
          <div class="mLabel">${label}</div>
          <div class="mVal">${v}</div>
        </div>
      `;
    }

    // =======================
    // DATA ACCESS
    // =======================
    async function testConnection(){
      const { error } = await supabase.from("report_days").select("report_date").limit(1);
      if (error) throw error;
    }

    async function fetchDay(dayISO){
      const { data: dayArr, error: e1 } = await supabase
        .from("report_days")
        .select("*")
        .eq("report_date", dayISO)
        .limit(1);
      if (e1) throw e1;
      const day = dayArr?.[0] || null;

      const { data: units, error: e2 } = await supabase
        .from("report_units")
        .select("*")
        .eq("report_date", dayISO)
        .order("unit_code", { ascending:true });
      if (e2) throw e2;

      return { day, units: units || [] };
    }

    async function fetchRange(dayISO){
      const from = addDaysISO(dayISO, -7);
      const to = dayISO;
      const { data, error } = await supabase
        .from("report_days")
        .select("report_date,q_ve_tb,q_chay_tb,water_level")
        .gte("report_date", from)
        .lte("report_date", to)
        .order("report_date", { ascending:true });
      if (error) throw error;
      return data || [];
    }

    function getUnit(units, code){
      return units.find(u=>u.unit_code === code) || null;
    }

    // =======================
    // COMMON RENDER
    // =======================
    function renderCommon(dayISO, day, h1, h2){
      $("basicTitle").textContent = dayISO ? `Ng√†y ${dayISO}` : "‚Äî";

      // --- S·∫£n l∆∞·ª£ng ng√†y: ∆∞u ti√™n sl_thuc_phat, fallback energy_kwh ---
      const e1src = h1?.sl_thuc_phat ?? h1?.energy_kwh;
      const e2src = h2?.sl_thuc_phat ?? h2?.energy_kwh;
      const e1 = Number(e1src);
      const e2 = Number(e2src);
      const has1 = Number.isFinite(e1);
      const has2 = Number.isFinite(e2);
      const esum = (has1?e1:0) + (has2?e2:0);

      $("eH1").textContent = has1 ? fmt0.format(e1) : "‚Äî";
      $("eH2").textContent = has2 ? fmt0.format(e2) : "‚Äî";
      $("eSum").textContent = (has1 || has2) ? fmt0.format(esum) : "‚Äî";
      $("eH1Sub").textContent = h1?.t_run != null ? `T: ${fmt.format(h1.t_run)} h` : "‚Äî";
      $("eH2Sub").textContent = h2?.t_run != null ? `T: ${fmt.format(h2.t_run)} h` : "‚Äî";

      // --- L≈©y k·∫ø th√°ng / nƒÉm ---
      const m1 = Number(h1?.lk_thang_kwh);
      const m2 = Number(h2?.lk_thang_kwh);
      const y1 = Number(h1?.lk_nam_kwh);
      const y2 = Number(h2?.lk_nam_kwh);
      const mSum = (Number.isFinite(m1)?m1:0) + (Number.isFinite(m2)?m2:0);
      const ySum = (Number.isFinite(y1)?y1:0) + (Number.isFinite(y2)?y2:0);
      const mSumOk = mSum > 0;
      const ySumOk = ySum > 0;

      $("eMonthTotal").textContent = mSumOk ? fmt0.format(mSum) : "‚Äî";
      $("eMonthSub").textContent =
        `H1: ${Number.isFinite(m1)?fmt0.format(m1):"‚Äî"} ‚Ä¢ H2: ${Number.isFinite(m2)?fmt0.format(m2):"‚Äî"}`;

      $("eYearTotal").textContent = ySumOk ? fmt0.format(ySum) : "‚Äî";
      $("eYearSub").textContent =
        `H1: ${Number.isFinite(y1)?fmt0.format(y1):"‚Äî"} ‚Ä¢ H2: ${Number.isFinite(y2)?fmt0.format(y2):"‚Äî"}`;

      // --- MNH ---
      const wl = day?.water_level;
      const mnh = day?.mnh_qt;
      const nsmo = day?.nsmo_tuan;
      $("basicMNH").textContent =
        (wl==null && mnh==null && nsmo==null) ? "‚Äî" :
        [wl,mnh,nsmo].map(v=>v==null?"‚Äî":fmt.format(v)).join(" / ");
      $("basicMNHSub").textContent = "M·ª±c n∆∞·ªõc h·ªì / MNH QT / NSMO";

      // --- Q: 3 m√†u ---
      const qv = day?.q_ve_tb;
      const qc = day?.q_chay_tb;
      const qx = day?.q_xa;

      if(qv==null && qc==null && qx==null){
        $("basicQ").textContent = "‚Äî";
      }else{
        const pieces = [];
        if(qv!=null){
          pieces.push(
            `<span class="qItem qVe"><span class="qDot"></span><span class="qLabel">Q v·ªÅ</span> ${fmt.format(qv)}</span>`
          );
        }
        if(qc!=null){
          pieces.push(
            `<span class="qItem qChay"><span class="qDot"></span><span class="qLabel">Q ch·∫°y</span> ${fmt.format(qc)}</span>`
          );
        }
        if(qx!=null){
          pieces.push(
            `<span class="qItem qXa"><span class="qDot"></span><span class="qLabel">Q x·∫£</span> ${fmt.format(qx)}</span>`
          );
        }
        $("basicQ").innerHTML = `<div class="qValueWrap">${pieces.join("")}</div>`;
      }
      $("basicQSub").textContent = "Q v·ªÅ / Q ch·∫°y / Q x·∫£";

      const lines = [];
      if(day?.note) lines.push(String(day.note));
      if(day?.pct_da_cap) lines.push("PCT ƒë√£ c·∫•p: " + String(day.pct_da_cap));
      if(day?.pct_da_khoa) lines.push("PCT ƒë√£ kh√≥a: " + String(day.pct_da_khoa));
      $("basicNote").textContent = lines.length ? lines.join(" | ") : "‚Äî";
      $("noteText").textContent = "Ghi ch√∫: " + (day?.note || "‚Äî");
    }

    function renderPlantCard(u){
      if(!u) return "";
      return `
        <div class="plantCard" style="margin-top:10px;">
          <div class="plantHead">
            <div class="name">üè≠ ${u.unit_code}</div>
            <span class="pill mono">${u.report_date}</span>
          </div>
          <div class="metrics">
            ${metricBox("S·∫£n l∆∞·ª£ng (kWh)", u.sl_thuc_phat ?? u.energy_kwh)}
            ${metricBox("T ch·∫°y (h)", u.t_run)}
            ${metricBox("Pmax (MW)", u.p_max)}
            ${metricBox("Pmin (MW)", u.p_min)}
            ${metricBox("AVC giao (kWh)", u.avc_giao)}
            ${metricBox("AVC nh·∫≠n (kWh)", u.avc_nhan)}
            ${metricBox("L≈©y k·∫ø th√°ng (kWh)", u.lk_thang_kwh)}
            ${metricBox("L≈©y k·∫ø nƒÉm (kWh)", u.lk_nam_kwh)}
            ${metricBox("Kh·ªüi ƒë·ªông ng√†y", u.start_today)}
            ${metricBox("Kh·ªüi ƒë·ªông l≈©y th√°ng", u.start_month)}
            ${metricBox("Kh·ªüi ƒë·ªông l≈©y nƒÉm", u.start_year)}
          </div>
        </div>
      `;
    }

    // =======================
    // CHARTS
    // =======================
    let currentTab = "energy";
    let chartInstance = null;
    let cache = { dayISO:null, day:null, units:null, rangeISO:null, rangeRows:null };

    function safeDestroyChart(){
      if(chartInstance && typeof chartInstance.destroy === "function"){
        chartInstance.destroy();
      }
      chartInstance = null;
    }

    function commonChartOptions(){
      return {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:"index", intersect:false },
        plugins:{
          legend:{ labels:{ color:"rgba(231,236,255,.88)" } },
          tooltip:{
            callbacks:{
              label:(ctx)=>{
                const v = ctx.parsed.y;
                const t = Number.isFinite(v) ? fmt.format(v) : "‚Äî";
                return ` ${ctx.dataset.label}: ${t}`;
              }
            }
          }
        },
        scales:{
          x:{ ticks:{ color:"rgba(231,236,255,.7)" }, grid:{ color:"rgba(255,255,255,.07)" } },
          y:{ ticks:{ color:"rgba(231,236,255,.7)" }, grid:{ color:"rgba(255,255,255,.07)" } }
        }
      };
    }

    function makeChart(config){
      const ctx = $("chart").getContext("2d");
      safeDestroyChart();
      chartInstance = new Chart(ctx, config);
    }

    function chartCompareH1H2(dayISO, h1, h2, field, label, rgb){
      const v1src = h1 ? (field==="energy_kwh" ? (h1.sl_thuc_phat ?? h1.energy_kwh) : h1[field]) : null;
      const v2src = h2 ? (field==="energy_kwh" ? (h2.sl_thuc_phat ?? h2.energy_kwh) : h2[field]) : null;
      const v1 = Number(v1src);
      const v2 = Number(v2src);

      $("metricName").textContent = tabMeta[currentTab].name;
      $("chartHint").textContent = `${label} ‚Ä¢ So s√°nh H1 vs H2 (ng√†y ${dayISO}).`;

      makeChart({
        type:"bar",
        data:{
          labels:["H1","H2"],
          datasets:[{
            label,
            data:[Number.isFinite(v1)?v1:null, Number.isFinite(v2)?v2:null],
            borderWidth:1.5,
            backgroundColor:[rgba(rgb,.35), rgba(rgb,.24)],
            borderColor:[rgba(rgb,.95), rgba(rgb,.7)]
          }]
        },
        options:commonChartOptions()
      });
    }

    function chartPMinMax(dayISO, unitLabel, u, rgb){
      const pmin = u ? Number(u.p_min) : null;
      const pmax = u ? Number(u.p_max) : null;

      $("metricName").textContent = unitLabel;
      $("chartHint").textContent = `Pmin & Pmax c·ªßa ${unitLabel} (ng√†y ${dayISO}).`;

      makeChart({
        type:"bar",
        data:{
          labels:["P min","P max"],
          datasets:[{
            label:unitLabel,
            data:[Number.isFinite(pmin)?pmin:null, Number.isFinite(pmax)?pmax:null],
            borderWidth:1.5,
            backgroundColor:[rgba(rgb,.28), rgba(rgb,.38)],
            borderColor:[rgba(rgb,.8), rgba(rgb,.95)]
          }]
        },
        options:commonChartOptions()
      });
    }

    async function ensureRangeLoaded(dayISO){
      if(cache.rangeISO === dayISO && cache.rangeRows) return;
      cache.rangeRows = await fetchRange(dayISO);
      cache.rangeISO = dayISO;
    }

    function chartMNH(rangeRows){
      const rgb = cssRGB("--c-mnh");
      const labels = rangeRows.map(r=>r.report_date);
      const data = rangeRows.map(r => {
        const n = Number(r.water_level);
        return Number.isFinite(n)?n:null;
      });

      $("metricName").textContent = tabMeta[currentTab].name;
      $("chartHint").textContent = "MNH (m·ª±c n∆∞·ªõc h·ªì) ‚Ä¢ Xu h∆∞·ªõng D-7 ‚Üí D-1.";

      const opts = commonChartOptions();
      opts.plugins.tooltip.callbacks.label = (ctx)=>{
        const v = ctx.parsed.y;
        const t = Number.isFinite(v)?fmt.format(v):"‚Äî";
        return ` MNH: ${t} m`;
      };

      makeChart({
        type:"line",
        data:{
          labels,
          datasets:[{
            label:"M·ª±c n∆∞·ªõc h·ªì (m)",
            data,
            spanGaps:true,
            tension:.35,
            borderWidth:2,
            borderColor:rgba(rgb,.96),
            backgroundColor:rgba(rgb,.24),
            pointRadius:3,
            pointHoverRadius:6,
            fill:true
          }]
        },
        options:opts
      });
    }

    function chartQ(rangeRows){
      const rgbVe = cssRGB("--c-qve");
      const rgbCh = cssRGB("--c-qch");
      const labels = rangeRows.map(r=>r.report_date);
      const dataVe = rangeRows.map(r => {
        const n = Number(r.q_ve_tb);
        return Number.isFinite(n)?n:null;
      });
      const dataCh = rangeRows.map(r => {
        const n = Number(r.q_chay_tb);
        return Number.isFinite(n)?n:null;
      });

      $("metricName").textContent = tabMeta[currentTab].name;
      $("chartHint").textContent = "Q ch·∫°y m√°y & Q v·ªÅ (m¬≥/s) ‚Ä¢ Xu h∆∞·ªõng D-7 ‚Üí D-1.";

      const opts = commonChartOptions();
      opts.plugins.tooltip.callbacks.label = (ctx)=>{
        const v = ctx.parsed.y;
        const t = Number.isFinite(v)?fmt.format(v):"‚Äî";
        return ` ${ctx.dataset.label}: ${t} m¬≥/s`;
      };

      makeChart({
        type:"line",
        data:{
          labels,
          datasets:[
            {
              label:"Q v·ªÅ (m¬≥/s)",
              data:dataVe,
              spanGaps:true,
              tension:.35,
              borderWidth:2,
              borderColor:rgba(rgbVe,.96),
              backgroundColor:rgba(rgbVe,.18),
              pointRadius:3,
              pointHoverRadius:6,
              fill:true
            },
            {
              label:"Q ch·∫°y m√°y (m¬≥/s)",
              data:dataCh,
              spanGaps:true,
              tension:.35,
              borderWidth:2,
              borderColor:rgba(rgbCh,.96),
              backgroundColor:rgba(rgbCh,.18),
              pointRadius:3,
              pointHoverRadius:6,
              fill:true
            }
          ]
        },
        options:opts
      });
    }

    async function renderChart(dayISO, day, units){
      const h1 = getUnit(units,"H1");
      const h2 = getUnit(units,"H2");
      const meta = tabMeta[currentTab];
      $("tabHint").textContent = meta.hint;

      const rgb = cssRGB(meta.color);

      if(currentTab === "energy"){
        return chartCompareH1H2(dayISO, h1, h2, "energy_kwh", "S·∫£n l∆∞·ª£ng (kWh)", rgb);
      }
      if(currentTab === "runtime"){
        return chartCompareH1H2(dayISO, h1, h2, "t_run", "T ch·∫°y m√°y (h)", rgb);
      }
      if(currentTab === "P_H1"){
        return chartPMinMax(dayISO, "P_H1", h1, rgb);
      }
      if(currentTab === "P_H2"){
        return chartPMinMax(dayISO, "P_H2", h2, rgb);
      }
      await ensureRangeLoaded(dayISO);
      const rows = cache.rangeRows || [];
      if(currentTab === "MNH_7D"){
        return chartMNH(rows);
      }
      if(currentTab === "Q_7D"){
        return chartQ(rows);
      }
    }

    // =======================
    // LOAD + UI
    // =======================
    async function loadDay(){
      const dayISO = $("day").value;
      $("dateText").textContent = dayISO || "‚Äî";
      if(!dayISO){
        toast("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£");
        return;
      }

      $("btnLoad").disabled = true;
      $("detailWrap").innerHTML = `<div class="empty">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>`;
      safeDestroyChart();

      try{
        const { day, units } = await fetchDay(dayISO);
        cache.dayISO = dayISO;
        cache.day = day;
        cache.units = units;

        const h1 = getUnit(units,"H1");
        const h2 = getUnit(units,"H2");

        if(!day && (!h1 && !h2)){
          $("detailWrap").innerHTML = `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†y n√†y.</div>`;
          toast("Ng√†y n√†y ch∆∞a c√≥ d·ªØ li·ªáu");
          return;
        }

        renderCommon(dayISO, day, h1, h2);

        const view = $("view").value;
        let html = "";
        if(view === "BOTH"){
          html = renderPlantCard(h1) + renderPlantCard(h2);
        }else if(view === "H1"){
          html = renderPlantCard(h1) || `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu H1 cho ng√†y n√†y.</div>`;
        }else{
          html = renderPlantCard(h2) || `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu H2 cho ng√†y n√†y.</div>`;
        }
        $("detailWrap").innerHTML = html;

        await renderChart(dayISO, day, units);
        toast("ƒê√£ t·∫£i d·ªØ li·ªáu");
      }catch(e){
        $("detailWrap").innerHTML = `<div class="empty">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: <span class="mono">${e.message || String(e)}</span></div>`;
        safeDestroyChart();
        toast("L·ªói t·∫£i d·ªØ li·ªáu");
      }finally{
        $("btnLoad").disabled = false;
      }
    }

    // =======================
    // INIT
    // =======================
    window.addEventListener("load", async ()=>{
      $("day").value = getDMinus1ISO();
      $("dateText").textContent = $("day").value;

      setConn("", "ƒêang ki·ªÉm tra Supabase‚Ä¶");
      try{
        await testConnection();
        setConn("ok","K·∫øt n·ªëi OK");
      }catch(e){
        setConn("err","L·ªói k·∫øt n·ªëi / RLS");
        toast("Ki·ªÉm tra RLS / anon key");
      }

      await loadDay();
    });

    $("btnLoad").addEventListener("click", loadDay);
    $("day").addEventListener("change", loadDay);
    $("view").addEventListener("change", loadDay);

    $("metricTabs").addEventListener("click", async (e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      currentTab = t.dataset.m;

      const meta = tabMeta[currentTab];
      $("metricName").textContent = meta.name;
      $("tabHint").textContent = meta.hint;

      const dayISO = $("day").value;
      if(!dayISO) return;
      try{
        if(cache.dayISO === dayISO && cache.day){
          await renderChart(dayISO, cache.day, cache.units || []);
        }else{
          await loadDay();
        }
        toast(`Bi·ªÉu ƒë·ªì: ${meta.name}`);
      }catch(err){
        safeDestroyChart();
        toast("Kh√¥ng v·∫Ω ƒë∆∞·ª£c bi·ªÉu ƒë·ªì");
      }
    });
  </script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("SW OK"))
      .catch(err => console.log("SW l·ªói:", err));
  });
}
</script>
</body>
</html>
