<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard b√°o c√°o s·∫£n xu·∫•t ng√†y ‚Ä¢ V2.1</title>

  <!-- PWA -->
  <meta name="theme-color" content="#050816" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060314;

      --card:rgba(10,15,40,.96);
      --stroke:rgba(255,255,255,.10);

      --text:#E7ECFF;
      --text2:rgba(231,236,255,.86);
      --muted:rgba(231,236,255,.64);
      --muted2:rgba(231,236,255,.44);

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;

      --c-prod: 96,165,250;
      --c-run:  52,211,153;
      --c-ph1:  251,191,36;
      --c-ph2:  167,139,250;
      --c-mnh:  34,211,238;
      --c-qve:  59,130,246;
      --c-qch:  248,113,113;
      --c-qxa:  251,191,36;

      --good:#34D399;
      --bad:#FB7185;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 20% -10%, rgba(96,165,250,.28), transparent 60%),
        radial-gradient(900px 520px at 45% 120%, rgba(52,211,153,.18), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }

    .app{ max-width: 560px; margin:0 auto; min-height:100%; padding:12px 12px 28px; }
    .topbar{
      position:sticky; top:0; z-index:10;
      padding:10px 2px 10px;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,8,22,.85), rgba(5,8,22,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    h1{ margin:0; font-size:17px; letter-spacing:.3px; display:flex; align-items:center; gap:8px; color:var(--text2); }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }

    .chip.version{
      border-color:rgba(96,165,250,.5);
      background:rgba(96,165,250,.14);
      color:rgba(209,233,255,.96);
      font-weight:600;
      letter-spacing:.25px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius2);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-top:12px;
    }

    .cardHead{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .kpi{
      padding:11px 11px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      min-height:76px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ margin-top:6px; font-size:18px; font-weight:800; color:var(--text); }
    .kpi .sub{ margin-top:4px; font-size:11px; color:var(--muted2); }

    .progressBar{
      height:8px;
      width:100%;
      background:rgba(255,255,255,.08);
      border-radius:6px;
      overflow:hidden;
      margin-top:6px;
    }
    .progressFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(96,165,250,.9), rgba(167,139,250,.9));
      transition: width .35s ease;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="titleRow">
        <h1>üìä Dashboard b√°o c√°o ng√†y
          <span class="chip"><span id="dot" class="dot"></span><span id="connText">ƒêang ki·ªÉm tra‚Ä¶</span></span>
        </h1>
        <span class="chip version">v2.1</span>
      </div>
    </div>

    <!-- ========== CH·ªåN NG√ÄY ========== -->
    <section class="card">
      <div class="cardHead">
        <b>Ng√†y b√°o c√°o</b>
        <span class="chip mono" id="dateText">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="control">
            <label for="day">Ch·ªçn ng√†y</label>
            <input id="day" type="date">
          </div>
          <div class="control">
            <label for="view">Ch·ªçn xem t·ªï m√°y</label>
            <select id="view">
              <option value="BOTH">H1 + H2</option>
              <option value="H1">Ch·ªâ H1</option>
              <option value="H2">Ch·ªâ H2</option>
            </select>
          </div>
          <div class="control" style="flex:0; min-width:140px;">
            <label>&nbsp;</label>
            <button id="btnLoad" class="primary">T·∫£i b√°o c√°o</button>
          </div>
        </div>
        <div class="hint">
          L·∫•y d·ªØ li·ªáu t·ª´ <span class="mono">report_days</span> v√† <span class="mono">report_units</span>.
        </div>
      </div>
    </section>

    <!-- ========== TH√îNG TIN T·ªîNG QUAN ========== -->
    <section class="card">
      <div class="cardHead">
        <b>Th√¥ng tin t·ªïng quan</b>
        <span class="chip" id="basicTitle">‚Äî</span>
      </div>

      <div class="cardBody">

        <!-- S·∫¢N L∆Ø·ª¢NG -->
        <div class="grid3">
          <div class="kpi">
            <div class="label">H1 (kWh)</div>
            <div class="value" id="eH1">‚Äî</div>
            <div class="sub" id="eH1Sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">H2 (kWh)</div>
            <div class="value" id="eH2">‚Äî</div>
            <div class="sub" id="eH2Sub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">T·ªïng ng√†y (kWh)</div>
            <div class="value" id="eSum">‚Äî</div>
            <div class="sub">H1 + H2</div>
          </div>
        </div>

        <!-- L≈®Y K·∫æ -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">L≈©y k·∫ø th√°ng</div>
            <div class="value" id="eMonthTotal">‚Äî</div>
            <div class="sub" id="eMonthSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">L≈©y k·∫ø nƒÉm</div>
            <div class="value" id="eYearTotal">‚Äî</div>
            <div class="sub" id="eYearSub">‚Äî</div>
          </div>
        </div>

        <!-- ƒêI·ªÜN T·ª∞ D√ôNG -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">ƒêi·ªán t·ª± d√πng (kWh)</div>
            <div class="value" id="eSelfTotal">‚Äî</div>
            <div class="sub" id="eSelfSub">H1 / H2</div>
          </div>
          <div class="kpi">
            <div class="label">T·ª∑ l·ªá (%)</div>
            <div class="value" id="selfRatio">‚Äî</div>
            <div class="sub">Tr√™n t·ªïng ng√†y</div>
          </div>
        </div>

        <!-- MNH & Q -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">MNH (m)</div>
            <div class="value" id="basicMNH">‚Äî</div>
            <div class="sub">MNH ‚Äì QT ‚Äì NSMO</div>
          </div>
          <div class="kpi">
            <div class="label">Q (m¬≥/s)</div>
            <div class="value" id="basicQ">‚Äî</div>
            <div class="sub">Qv / Q ch·∫°y / Q x·∫£</div>
          </div>
        </div>

        <!-- M∆ØA ‚Äì PCT -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">M∆∞a</div>
            <div class="value" id="rainValue">‚Äî</div>
            <div class="sub" id="rainSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Phi·∫øu c√¥ng t√°c</div>
            <div class="value" id="workValue">‚Äî</div>
            <div class="sub" id="workSub">‚Äî</div>
          </div>
        </div>

        <!-- SL ƒêƒÇNG K√ù ‚Äì A0 ‚Äì QC -->
        <div class="grid3" style="margin-top:14px;">
          <div class="kpi">
            <div class="label">SL ƒëƒÉng k√Ω ph√°t</div>
            <div class="value" id="slDangKy">‚Äî</div>
            <div class="progressBar"><div id="pgDK" class="progressFill"></div></div>
          </div>
          <div class="kpi">
            <div class="label">A0 huy ƒë·ªông</div>
            <div class="value" id="slA0">‚Äî</div>
            <div class="progressBar"><div id="pgA0" class="progressFill"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Qc th√°ng 12</div>
            <div class="value" id="slQc12">‚Äî</div>
            <div class="progressBar"><div id="pgQC" class="progressFill"></div></div>
          </div>
        </div>

        <div class="noteBox" style="margin-top:15px;">
          <div class="label">Ghi ch√∫</div>
          <div id="basicNote">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- ========== CH·ªåN BI·ªÇU ƒê·ªí ========== -->
    <section class="card">
      <div class="cardHead">
        <b>Ch·ªçn bi·ªÉu ƒë·ªì</b>
        <div class="tabs" id="metricTabs">
          <span class="tab active" data-m="energy"><span class="swatch" style="background:rgba(96,165,250,.9)"></span>S·∫£n l∆∞·ª£ng</span>
          <span class="tab" data-m="runtime"><span class="swatch" style="background:rgba(52,211,153,.9)"></span>T ch·∫°y</span>
          <span class="tab" data-m="P_H1"><span class="swatch" style="background:rgba(251,191,36,.9)"></span>P_H1</span>
          <span class="tab" data-m="P_H2"><span class="swatch" style="background:rgba(167,139,250,.9)"></span>P_H2</span>
          <span class="tab" data-m="MNH_7D"><span class="swatch" style="background:rgba(34,211,238,.9)"></span>MNH</span>
          <span class="tab" data-m="Q_7D"><span class="swatch" style="background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(248,113,113,.9))"></span>Q</span>
        </div>
      </div>

      <div class="cardBody">
        <div class="hint" id="tabHint">So s√°nh S·∫£n l∆∞·ª£ng H1 ‚Äì H2.</div>
      </div>
    </section>

    <!-- ========== BI·ªÇU ƒê·ªí ========== -->
    <section class="card">
      <div class="cardHead">
        <b>Bi·ªÉu ƒë·ªì</b>
        <span class="chip" id="metricName">S·∫£n l∆∞·ª£ng</span>
      </div>
      <div class="cardBody">
        <canvas id="chart"></canvas>
        <div class="hint" id="chartHint">‚Äî</div>
      </div>
    </section>

    <!-- ========== CHI TI·∫æT T·ªî M√ÅY ========== -->
    <section class="card">
      <div class="cardHead">
        <b>Chi ti·∫øt t·ªï m√°y</b>
        <span class="chip mono" id="noteText">Ghi ch√∫: ‚Äî</span>
      </div>
      <div class="cardBody" id="detailWrap"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Supabase & ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// ==========================
//  KHAI B√ÅO SUPABASE
// ==========================
const SUPABASE_URL = "https://sjhepenyiedyzwpponhz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTY5MzM4NzAyNiwiZXhwIjo0ODQ5MTYzMDI2fQ.GrEJCLbT6G7fGJINh-TtAjNyhgB3ALKlmO9jUqAMiXE";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==========================
//   H√ÄM TI·ªÜN √çCH
// ==========================
function f(n) {
  if (n === null || n === undefined) return "‚Äî";
  return Number(n).toLocaleString("vi-VN");
}

function pct(a, b) {
  if (!a || !b || b === 0) return "‚Äî";
  return ((a/b) * 100).toFixed(1) + "%";
}

function setProgress(id, val, max) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!val || !max || max === 0) {
    el.style.width = "0%";
    return;
  }
  let p = (val / max) * 100;
  if (p > 100) p = 100;
  el.style.width = p + "%";
}

// ==========================
//   K·∫æT N·ªêI M·∫†NG
// ==========================
function updateConn() {
  const dot = document.getElementById("dot");
  const t = document.getElementById("connText");

  if (navigator.onLine) {
    dot.style.background = "limegreen";
    t.innerText = "Online";
  } else {
    dot.style.background = "red";
    t.innerText = "Offline";
  }
}
setInterval(updateConn, 1500);
updateConn();

// ==========================
//   T·∫¢I B√ÅO C√ÅO
// ==========================
document.getElementById("btnLoad").onclick = loadReport;

async function loadReport() {
  const day = document.getElementById("day").value;
  if (!day) {
    showToast("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£!");
    return;
  }

  document.getElementById("dateText").innerText = day;

  // ===== L·∫§Y report_days =====
  const { data: d0, error: e0 } = await db
    .from("report_days")
    .select("*")
    .eq("report_date", day)
    .maybeSingle();

  if (e0) {
    showToast("L·ªói l·∫•y report_days");
    return;
  }

  // ===== L·∫§Y report_units (H1, H2) =====
  const { data: units, error: e1 } = await db
    .from("report_units")
    .select("*")
    .eq("report_date", day);

  if (e1) {
    showToast("L·ªói l·∫•y report_units");
    return;
  }

  renderBasics(d0, units);
  renderUnits(units);
  updateCharts(day, units, d0);
}

// ==========================
//   RENDER PH·∫¶N T·ªîNG QUAN
// ==========================
function renderBasics(d, units) {
  if (!d) return;

  // Hai t·ªï m√°y
  const H1 = units.find(u => u.unit_code === "H1");
  const H2 = units.find(u => u.unit_code === "H2");

  // Gi√° tr·ªã s·∫£n l∆∞·ª£ng
  const e1 = H1?.energy_kwh || 0;
  const e2 = H2?.energy_kwh || 0;
  const eSum = e1 + e2;

  document.getElementById("eH1").innerText = f(e1);
  document.getElementById("eH2").innerText = f(e2);
  document.getElementById("eSum").innerText = f(eSum);

  document.getElementById("eH1Sub").innerText =
    `${f(H1?.p_max)} / ${f(H1?.p_min)} MW`;
  document.getElementById("eH2Sub").innerText =
    `${f(H2?.p_max)} / ${f(H2?.p_min)} MW`;

  // L≈©y k·∫ø
  const m1 = H1?.lk_thang_kwh || 0;
  const m2 = H2?.lk_thang_kwh || 0;
  const y1 = H1?.lk_nam_kwh || 0;
  const y2 = H2?.lk_nam_kwh || 0;

  document.getElementById("eMonthTotal").innerText = f(m1 + m2);
  document.getElementById("eMonthSub").innerText = `${f(m1)} / ${f(m2)}`;

  document.getElementById("eYearTotal").innerText = f(y1 + y2);
  document.getElementById("eYearSub").innerText = `${f(y1)} / ${f(y2)}`;

  // ƒêi·ªán t·ª± d√πng
  const td = Number(d.td_tong || 0);
  document.getElementById("eSelfTotal").innerText = f(td);
  document.getElementById("selfRatio").innerText = d.td_tyle
      ? d.td_tyle + "%"
      : pct(td, eSum);

  document.getElementById("eSelfSub").innerText =
    `${f(d.td_h1)} / ${f(d.td_h2)}`;

  // MNH + Q
  document.getElementById("basicMNH").innerText =
    `${f(d.water_level)} | ${f(d.mnh_qt)} | ${f(d.nsmo_tuan)}`;

  document.getElementById("basicQ").innerText =
    `${f(d.q_ve_tb)} | ${f(d.q_chay_tb)} | ${f(d.q_xa)}`;

  // M∆∞a
  document.getElementById("rainValue").innerText = `${f(d.rain_day)} mm`;
  document.getElementById("rainSub").innerText =
    `L≈©y k·∫ø nƒÉm: ${f(d.rain_year)} mm`;

  // C√¥ng t√°c
  document.getElementById("workValue").innerText =
    (d.pct_da_khoa || "‚Äî");
  document.getElementById("workSub").innerText =
    `ƒê√£ c·∫•p: ${d.pct_da_cap || "‚Äî"}`;

  // Ghi ch√∫
  document.getElementById("basicNote").innerText =
    d.note || "‚Äî";

  // SL ƒëƒÉng k√Ω ‚Äì A0 ‚Äì QC th√°ng 12 (t·ªïng 2 t·ªï m√°y)
  const dk = (H1?.sl_ke_hoach || 0) + (H2?.sl_ke_hoach || 0);
  const a0 = (H1?.sl_tu_khien || 0) + (H2?.sl_tu_khien || 0);
  const qc = (H1?.sl_qc_thang12 || 0) + (H2?.sl_qc_thang12 || 0);

  document.getElementById("slDangKy").innerText = f(dk);
  document.getElementById("slA0").innerText = f(a0);
  document.getElementById("slQc12").innerText = f(qc);

  // Progress bar m√†u ƒë·ªông
  setProgress("pgDK", dk, eSum);
  setProgress("pgA0", a0, eSum);
  setProgress("pgQC", qc, eSum);
}

// ==========================
//   RENDER CHI TI·∫æT H1 ‚Äì H2
// ==========================
function renderUnits(units) {
  const wrap = document.getElementById("detailWrap");
  wrap.innerHTML = "";

  const view = document.getElementById("view").value;
  const show = units.filter(u =>
    view === "BOTH" ? true : u.unit_code === view
  );

  show.forEach(u => {
    wrap.innerHTML += `
      <div class="unitBox">
        <h3>${u.unit_code}</h3>
        <table>
          <tr><td>P Max</td><td>${f(u.p_max)}</td></tr>
          <tr><td>P Min</td><td>${f(u.p_min)}</td></tr>
          <tr><td>T ch·∫°y (h)</td><td>${f(u.t_run)}</td></tr>
          <tr><td>S·∫£n l∆∞·ª£ng (kWh)</td><td>${f(u.energy_kwh)}</td></tr>
          <tr><td>AVC giao</td><td>${f(u.avc_giao)}</td></tr>
          <tr><td>AVC nh·∫≠n</td><td>${f(u.avc_nhan)}</td></tr>
          <tr><td>SL th√°ng (kWh)</td><td>${f(u.lk_thang_kwh)}</td></tr>
          <tr><td>SL nƒÉm (kWh)</td><td>${f(u.lk_nam_kwh)}</td></tr>
          <tr><td>Kh·ªüi ƒë·ªông h√¥m nay</td><td>${f(u.start_today)}</td></tr>
          <tr><td>Kh·ªüi ƒë·ªông th√°ng</td><td>${f(u.start_month)}</td></tr>
          <tr><td>Kh·ªüi ƒë·ªông nƒÉm</td><td>${f(u.start_year)}</td></tr>
        </table>
      </div>
    `;
  });
}

// ==========================
//   BI·ªÇU ƒê·ªí ‚Äì CHARTJS
// ==========================
let chart;

async function updateCharts(day, units, d0) {
  // L·∫•y d·ªØ li·ªáu 7 ng√†y ƒë·ªÉ v·∫Ω MNH ‚Äì Q ‚Äì s·∫£n l∆∞·ª£ng
  const { data: days } = await db
    .from("report_days")
    .select("*")
    .lte("report_date", day)
    .order("report_date", { ascending: false })
    .limit(7);

  const labels = days.map(d => d.report_date).reverse();
  const mnh = days.map(d => d.water_level);
  const qve = days.map(d => d.q_ve_tb);

  const H1 = units.find(u => u.unit_code === "H1");
  const H2 = units.find(u => u.unit_code === "H2");

  const e1 = H1?.energy_kwh || 0;
  const e2 = H2?.energy_kwh || 0;

  if (chart) chart.destroy();

  const ctx = document.getElementById("chart");

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "MNH",
          data: mnh,
          borderWidth: 3,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      }
    }
  });

  document.getElementById("chartHint").innerText =
    "D·ªØ li·ªáu 7 ng√†y g·∫ßn nh·∫•t.";
}

// ==========================
//   TOAST TH√îNG B√ÅO
// ==========================
function showToast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}
</script>
