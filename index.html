<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard b√°o c√°o s·∫£n xu·∫•t ng√†y ‚Ä¢ V2.3</title>

  <!-- PWA -->
  <meta name="theme-color" content="#050816" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060314;

      --card:rgba(10,15,40,.96);
      --stroke:rgba(255,255,255,.10);

      --text:#E7ECFF;
      --text2:rgba(231,236,255,.86);
      --muted:rgba(231,236,255,.64);
      --muted2:rgba(231,236,255,.44);

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --c-prod: 96,165,250;   /* s·∫£n l∆∞·ª£ng */
      --c-run:  52,211,153;   /* T ch·∫°y */
      --c-h1p:  251,191,36;   /* H1 24h */
      --c-h2p:  167,139,250;  /* H2 24h */
      --c-a0p:  248,113,113;  /* NSMO 24h */
      --c-mnh:  34,211,238;   /* MNH */

      /* 3 m√†u ‚Äúchu·∫©n‚Äù nh∆∞ Q */
      --c-qve:  59,130,246;   /* H1 / Q v·ªÅ */
      --c-qch:  248,113,113;  /* H2 / Q ch·∫°y */
      --c-qxa:  251,191,36;   /* T·ªïng / Q x·∫£ */

      --good:#34D399;
      --bad:#FB7185;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 20% -10%, rgba(96,165,250,.28), transparent 60%),
        radial-gradient(900px 520px at 45% 120%, rgba(52,211,153,.18), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }

    .app{ max-width: 560px; margin:0 auto; min-height:100%; padding:12px 12px 28px; }

    .topbar{
      position:sticky; top:0; z-index:10;
      padding:10px 2px 10px;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,8,22,.85), rgba(5,8,22,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .titleRow{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:6px 6px 10px;
    }
    h1{ margin:0; font-size:17px; letter-spacing:.3px; display:flex; align-items:center; gap:8px; color:var(--text2); }
    small{ color:var(--muted); font-size:12px; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .chip.version{
      border-color:rgba(96,165,250,.5);
      background:rgba(96,165,250,.14);
      color:rgba(209,233,255,.96);
      font-weight:600;
      letter-spacing:.25px;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background:rgba(255,255,255,.35); box-shadow: 0 0 0 6px rgba(255,255,255,.06); }
    .dot.ok{ background:var(--good); box-shadow:0 0 0 6px rgba(52,211,153,.17); }
    .dot.err{ background:var(--bad); box-shadow:0 0 0 6px rgba(251,113,133,.17); }

    .card{
      background:var(--card);
      border-radius:var(--radius2);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-top:12px;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:linear-gradient(90deg,rgba(255,255,255,.05),rgba(255,255,255,.01));
    }
    .cardHead b{ font-size:13px; letter-spacing:.2px; color:var(--text2); }
    .cardBody{ padding:12px 14px 14px; }

    label{ font-size:12px; color:var(--muted); }
    input, select, button{
      font-family:var(--sans);
      font-size:14px;
      color:var(--text);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      padding:9px 12px;
      outline:none;
    }
    input[type="date"]{ padding:8px 12px; }
    button{
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:active{ transform:translateY(1px); }
    button.primary{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.55);
    }
    button.primary:hover{
      background:rgba(96,165,250,.26);
      border-color:rgba(96,165,250,.8);
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:end; }
    .control{ flex:1; min-width:160px; display:flex; flex-direction:column; gap:6px; }

    .hint{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.45; }
    .mono{ font-family:var(--mono); }

    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* =========================
       KPI GROUP COLORS (5 nh√≥m)
       ========================= */
    :root{
      --g1: var(--c-qve); /* Nh√≥m 1: H1 */
      --g2: var(--c-qch); /* Nh√≥m 2: H2 */
      --g3: var(--c-qxa); /* Nh√≥m 3: T·ªïng */
      --g4: var(--c-mnh); /* Nh√≥m 4: MNH */
      --g5: 167,139,250;  /* Nh√≥m 5: Kh√°c */
    }

    .kpi{
      padding:11px 11px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 0% 0%, rgba(255,255,255,.07), rgba(7,11,30,.98));
      min-height:76px;
      position:relative;
      overflow:hidden;
    }
    .kpi:after{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(420px 120px at 15% 0%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(260px 160px at 0% 0%, rgba(255,255,255,.05), transparent 65%);
      pointer-events:none;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ margin-top:6px; font-size:18px; font-weight:800; letter-spacing:.25px; color:var(--text); }
    .kpi .sub{ margin-top:4px; font-size:11px; color:var(--muted2); opacity:.9; }

    .kpi .label:before{
      content:"";
      display:inline-block;
      width:9px;height:9px;border-radius:999px;
      margin-right:8px;
      vertical-align:middle;
      background:rgba(255,255,255,.30);
      box-shadow: 0 0 0 5px rgba(255,255,255,.06);
    }

    .kpi[data-g]{
      border-color: rgba(var(--g-rgb), .20);
      background:
        radial-gradient(520px 160px at 20% -20%, rgba(var(--g-rgb), .18), transparent 60%),
        radial-gradient(260px 160px at 0% 0%, rgba(255,255,255,.06), transparent 70%),
        rgba(7,11,30,.98);
    }
    .kpi[data-g] .label:before{
      background: rgba(var(--g-rgb), .95);
      box-shadow: 0 0 0 5px rgba(var(--g-rgb), .12), 0 0 18px rgba(var(--g-rgb), .18);
    }
    .kpi[data-g] .value{
      color: rgba(var(--g-rgb), .98);
      text-shadow: 0 0 18px rgba(var(--g-rgb), .18);
    }
    .kpi[data-g] .sub{ color: rgba(231,236,255,.72); }

    .kpi.g1{ --g-rgb: var(--g1); } /* H1 */
    .kpi.g2{ --g-rgb: var(--g2); } /* H2 */
    .kpi.g3{ --g-rgb: var(--g3); } /* T·ªïng */
    .kpi.g4{ --g-rgb: var(--g4); } /* MNH */
    .kpi.g5{ --g-rgb: var(--g5); } /* Kh√°c */

    .sub .h1v{ color: rgba(var(--c-qve), .95); font-weight:800; }
    .sub .h2v{ color: rgba(var(--c-qch), .95); font-weight:800; }
    .sub .sumv{ color: rgba(var(--c-qxa), .95); font-weight:800; }

    .noteBox{
      margin-top:10px;
      padding:11px 11px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      font-size:13px;
      color:var(--text2);
      line-height:1.45;
    }
    .noteBox .label{ font-size:12px; color:var(--muted); margin-bottom:4px; }

    .tabs{ display:flex; flex-wrap:wrap; gap:8px; }
    .tab{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:7px;
      cursor:pointer;
      user-select:none;
    }
    .swatch{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 0 0 4px rgba(255,255,255,.04);
    }
    .tab.active{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.22);
      color:var(--text2);
      font-weight:700;
    }

    canvas{ width:100% !important; height:280px !important; }

    /* =========================
       CHI TI·∫æT T·ªî M√ÅY (pro color)
       ========================= */
    .plantCard{
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(7,10,32,.96);
      overflow:hidden;
      position:relative;
    }
    .plantCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 180px at 15% -20%, rgba(var(--u-rgb), .16), transparent 60%);
      pointer-events:none;
    }
    .plantCard.h1{ --u-rgb: var(--c-qve); border-color: rgba(var(--c-qve), .22); }
    .plantCard.h2{ --u-rgb: var(--c-qch); border-color: rgba(var(--c-qch), .22); }

    .plantHead{
      padding:11px 14px;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(90deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      position:relative;
    }
    .plantHead .name{
      font-weight:800; letter-spacing:.3px; color:var(--text2);
      display:flex; align-items:center; gap:8px;
    }
    .plantHead .name:before{
      content:"";
      width:10px;height:10px;border-radius:999px;
      background: rgba(var(--u-rgb), .95);
      box-shadow: 0 0 0 5px rgba(var(--u-rgb), .12), 0 0 18px rgba(var(--u-rgb), .18);
      display:inline-block;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.unit{
      border-color: rgba(var(--u-rgb), .26);
      background: rgba(var(--u-rgb), .10);
      color: rgba(231,236,255,.92);
    }

    .metrics{
      padding:11px 14px 12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      position:relative;
    }
    .metric{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.09);
      background:rgba(255,255,255,.03);
      padding:9px 9px;
      min-height:60px;
    }
    .metric .mLabel{ font-size:12px; color:var(--muted2); display:flex; align-items:center; gap:6px; }
    .metric .mLabel:before{
      content:"";
      width:7px;height:7px;border-radius:999px;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.04);
      display:inline-block;
    }
    .metric.u .mLabel:before{
      background: rgba(var(--u-rgb), .90);
      box-shadow: 0 0 0 4px rgba(var(--u-rgb), .10);
    }
    .metric .mVal{
      margin-top:5px;
      font-weight:900;
      color:rgba(231,236,255,.92);
    }
    .metric.u .mVal{
      color: rgba(var(--u-rgb), .98);
      text-shadow: 0 0 16px rgba(var(--u-rgb), .16);
    }

    .empty{ padding:18px 14px; font-size:13px; color:var(--muted); text-align:center; }

    .toast{
      position:fixed; left:12px; right:12px; bottom:14px;
      max-width:560px; margin:0 auto;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(6,10,34,.92);
      color:rgba(231,236,255,.92);
      font-size:13px;
      display:none;
      box-shadow:var(--shadow);
    }
    .toast.show{ display:block; }

    .qValueWrap{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .qItem{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
    }
    .qDot{ width:9px; height:9px; border-radius:999px; display:inline-block; vertical-align:middle; }
    .qVe  .qDot{ background:rgba(var(--c-qve),.95); box-shadow:0 0 12px rgba(var(--c-qve),.12); }
    .qChay .qDot{ background:rgba(var(--c-qch),.95); box-shadow:0 0 12px rgba(var(--c-qch),.12); }
    .qXa  .qDot{ background:rgba(var(--c-qxa),.95); box-shadow:0 0 12px rgba(var(--c-qxa),.12); }
    .qVe  .qLabel{ color:rgba(var(--c-qve),.92); font-weight:700; }
    .qChay .qLabel{ color:rgba(var(--c-qch),.92); font-weight:700; }
    .qXa  .qLabel{ color:rgba(var(--c-qxa),.92); font-weight:700; }
    .qNum{ font-weight:900; margin-left:6px; text-shadow: 0 0 16px rgba(255,255,255,.08); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="titleRow">
        <div>
          <h1>üìä Dashboard b√°o c√°o ng√†y
            <span class="chip"><span id="dot" class="dot"></span><span id="connText">ƒêang ki·ªÉm tra‚Ä¶</span></span>
          </h1>
          <small>M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã D-1 ‚Ä¢ L≈©y k·∫ø Th√°ng &amp; NƒÉm ‚Ä¢ Bi·ªÉu ƒë·ªì Q v·ªÅ + Q ch·∫°y m√°y</small>
        </div>
        <span class="chip version">v2.3</span>
      </div>
    </div>

    <!-- CH·ªåN NG√ÄY -->
    <section class="card">
      <div class="cardHead">
        <b>Ng√†y b√°o c√°o</b>
        <span class="chip mono" id="dateText">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="control">
            <label for="day">Ch·ªçn ng√†y</label>
            <input id="day" type="date">
          </div>
          <div class="control">
            <label for="view">Ch·ªçn xem NM ho·∫∑c T·ª´ng t·ªï m√°y</label>
            <select id="view">
              <option value="BOTH">H1 + H2</option>
              <option value="H1">Ch·ªâ H1</option>
              <option value="H2">Ch·ªâ H2</option>
            </select>
          </div>
          <div class="control" style="flex:0; min-width:140px;">
            <label>&nbsp;</label>
            <button id="btnLoad" class="primary" type="button">T·∫£i b√°o c√°o</button>
          </div>
        </div>
        <div class="hint">
          D·ªØ li·ªáu l·∫•y t·ª´ b·∫£ng <span class="mono">report_days</span>, <span class="mono">report_units</span> &amp; <span class="mono">power_hourly</span> tr√™n Supabase.
        </div>
      </div>
    </section>

    <!-- TH√îNG TIN CHUNG -->
    <section class="card">
      <div class="cardHead">
        <b>Th√¥ng tin t·ªïng quan</b>
        <span class="chip" id="basicTitle">‚Äî</span>
      </div>

      <div class="cardBody">
        <!-- NH√ìM 1: S·∫£n l∆∞·ª£ng ng√†y -->
        <div class="grid3">
          <div class="kpi g1" data-g="g1">
            <div class="label">S·∫£n l∆∞·ª£ng H1 (kWh)</div>
            <div class="value" id="eH1">‚Äî</div>
            <div class="sub" id="eH1Sub">‚Äî</div>
          </div>

          <div class="kpi g2" data-g="g2">
            <div class="label">S·∫£n l∆∞·ª£ng H2 (kWh)</div>
            <div class="value" id="eH2">‚Äî</div>
            <div class="sub" id="eH2Sub">‚Äî</div>
          </div>

          <div class="kpi g3" data-g="g3">
            <div class="label">T·ªïng s·∫£n l∆∞·ª£ng ng√†y (kWh)</div>
            <div class="value" id="eSum">‚Äî</div>
            <div class="sub" id="eSumSub">H1 + H2</div>
          </div>
        </div>

        <!-- NH√ìM 2: L≈©y k·∫ø th√°ng / nƒÉm -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi g3" data-g="g3">
            <div class="label">L≈©y k·∫ø th√°ng (kWh)</div>
            <div class="value" id="eMonthTotal">‚Äî</div>
            <div class="sub" id="eMonthSub">‚Äî</div>
          </div>

          <div class="kpi g3" data-g="g3">
            <div class="label">L≈©y k·∫ø nƒÉm (kWh)</div>
            <div class="value" id="eYearTotal">‚Äî</div>
            <div class="sub" id="eYearSub">‚Äî</div>
          </div>
        </div>

        <!-- NH√ìM 3: SL ƒëƒÉng k√Ω / A0 / QC -->
        <div class="grid3" style="margin-top:10px;">
          <div class="kpi g3" data-g="g3">
            <div class="label">SL ƒëƒÉng k√Ω (kWh)</div>
            <div class="value" id="slKeHoach">‚Äî</div>
            <div class="sub" id="slKeHoachSub">T·ªïng H1 + H2</div>
          </div>

          <div class="kpi g3" data-g="g3">
            <div class="label">NSMO d·ª± ki·∫øn huy ƒë·ªông (kWh)</div>
            <div class="value" id="slA0">‚Äî</div>
            <div class="sub" id="slA0Sub">T·ªïng H1 + H2</div>
          </div>

          <div class="kpi g3" data-g="g3">
            <div class="label">QC th√°ng (kWh)</div>
            <div class="value" id="slQC">‚Äî</div>
            <div class="sub" id="slQCSub">T·ªïng H1 + H2</div>
          </div>
        </div>

        <!-- NH√ìM 4: ƒêi·ªán t·ª± d√πng / t·ª∑ l·ªá -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi g3" data-g="g3">
            <div class="label">ƒêi·ªán t·ª± d√πng (kWh)</div>
            <div class="value" id="eSelfTotal">‚Äî</div>
            <div class="sub" id="eSelfSub">‚Äî</div>
          </div>

          <div class="kpi g5" data-g="g5">
            <div class="label">T·ª∑ l·ªá ƒëi·ªán t·ª± d√πng ng√†y(%)</div>
            <div class="value" id="selfRatio">‚Äî</div>
            <div class="sub" id="selfRatioSub">Tr√™n t·ªïng s·∫£n l∆∞·ª£ng ng√†y</div>
          </div>
        </div>

        <!-- NH√ìM 5: MNH & Q -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi g4" data-g="g4">
            <div class="label">MNH (m)</div>
            <div class="value" id="basicMNH">‚Äî</div>
            <div class="sub" id="basicMNHSub">M·ª±c n∆∞·ªõc h·ªì / MNH QT / NSMO</div>
          </div>

          <div class="kpi g5" data-g="g5">
            <div class="label">Q (m¬≥/s)</div>
            <div class="value" id="basicQ">‚Äî</div>
            <div class="sub" id="basicQSub">Q v·ªÅ / Q ch·∫°y / Q x·∫£</div>
          </div>
        </div>

        <!-- M∆∞a & PCT -->
        <div class="grid2" style="margin-top:10px;">
          <div class="kpi g5" data-g="g5">
            <div class="label">M∆∞a &amp; ph∆∞∆°ng th·ª©c AC</div>
            <div class="value" id="rainValue">‚Äî</div>
            <div class="sub" id="rainSub">M∆∞a ng√†y / M∆∞a nƒÉm ‚Ä¢ Ph∆∞∆°ng th·ª©c</div>
          </div>

          <div class="kpi g5" data-g="g5">
            <div class="label">S·ªë phi·∫øu c√¥ng t√°c</div>
            <div class="value" id="workValue">‚Äî</div>
            <div class="sub" id="workSub">ƒê√£ c·∫•p ‚Ä¢ ƒê√£ kh√≥a</div>
          </div>
        </div>

        <div class="noteBox">
          <div class="label">Ghi ch√∫ &amp; PCT</div>
          <div id="basicNote">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- TABS -->
    <section class="card">
      <div class="cardHead">
        <b>Ch·ªçn bi·ªÉu ƒë·ªì</b>
        <div class="tabs" id="metricTabs">
          <span class="tab active" data-m="energy">
            <span class="swatch" style="background:rgba(var(--c-prod),.9)"></span> S·∫£n l∆∞·ª£ng
          </span>
          <span class="tab" data-m="runtime">
            <span class="swatch" style="background:rgba(var(--c-run),.9)"></span> T ch·∫°y m√°y
          </span>

          <span class="tab" data-m="H1_24">
            <span class="swatch" style="background:rgba(var(--c-h1p),.9)"></span> H1 (24h)
          </span>
          <span class="tab" data-m="H2_24">
            <span class="swatch" style="background:rgba(var(--c-h2p),.9)"></span> H2 (24h)
          </span>
          <span class="tab" data-m="A0_24">
            <span class="swatch" style="background:rgba(var(--c-a0p),.9)"></span> NSMO (24h)
          </span>

          <span class="tab" data-m="MNH_7D">
            <span class="swatch" style="background:rgba(var(--c-mnh),.9)"></span> MNH (D-7‚ÜíD-1)
          </span>
          <span class="tab" data-m="Q_7D">
            <span class="swatch" style="background:linear-gradient(135deg,rgba(var(--c-qve),.9),rgba(var(--c-qch),.9))"></span> Q (D-7‚ÜíD-1)
          </span>
        </div>
      </div>
      <div class="cardBody">
        <div class="hint" id="tabHint">
          M·∫∑c ƒë·ªãnh: so s√°nh S·∫£n l∆∞·ª£ng (kWh) H1 vs H2 trong ng√†y. Bi·ªÉu ƒë·ªì H1/H2/NSMO (24h) l·∫•y t·ª´ b·∫£ng power_hourly.
        </div>
      </div>
    </section>

    <!-- CHART -->
    <section class="card">
      <div class="cardHead">
        <b>Bi·ªÉu ƒë·ªì</b>
        <span class="chip" id="metricName">S·∫£n l∆∞·ª£ng</span>
      </div>
      <div class="cardBody">
        <canvas id="chart"></canvas>
        <div class="hint" id="chartHint">‚Äî</div>
      </div>
    </section>

    <!-- CHI TI·∫æT T·ªî M√ÅY -->
    <section class="card">
      <div class="cardHead">
        <b>Chi ti·∫øt theo t·ªï m√°y</b>
        <span class="chip mono" id="noteText">Ghi ch√∫: ‚Äî</span>
      </div>
      <div class="cardBody" id="detailWrap"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Supabase & ChartJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// ========== DEBUG TO√ÄN C·ª§C ==========
window.addEventListener("error", (e) => {
  const el = document.getElementById("connText");
  if (el) el.textContent = "JS l·ªói: " + (e.message || "unknown");
  console.log("Global JS error:", e.message, e);
});

// ======================= SUPABASE CONFIG =======================
const SUPABASE_URL = "https://upicvbecjmzkfgoawupo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaWN2YmVjam16a2Znb2F3dXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTAzMTEsImV4cCI6MjA4MDkyNjMxMX0.3pVGVnP_OjkwLCvoVQzK7xaJRUaiFzJfopzUvPsWwXE";

let supabaseClient = null;
function getSupabase() {
  if (!supabaseClient) {
    if (!window.supabase || !window.supabase.createClient) {
      throw new Error("Supabase JS ch∆∞a load (window.supabase null)");
    }
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
  return supabaseClient;
}

// ======================= HELPERS =======================
const $      = id => document.getElementById(id);
const fmt    = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 2 });
const fmt0   = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 0 });
const cssRGB = v  => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
const rgba   = (rgb,a) => `rgba(${rgb}, ${a})`;

function setConn(kind, text){
  const dot = $("dot");
  if (dot) dot.className = "dot" + (kind ? " " + kind : "");
  const ct = $("connText");
  if (ct) ct.textContent = text;
}
function toast(msg){
  $("toast").textContent = msg;
  $("toast").classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>$("toast").classList.remove("show"), 2200);
}

function toISO(d){
  const yyyy = d.getFullYear();
  const mm   = String(d.getMonth()+1).padStart(2,"0");
  const dd   = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function addDaysISO(iso, delta){
  const [y,m,d] = iso.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate()+delta);
  return toISO(dt);
}
function getDMinus1ISO(){
  const d = new Date();
  d.setDate(d.getDate()-1);
  return toISO(d);
}

const tabMeta = {
  energy:  { name:"S·∫£n l∆∞·ª£ng",      hint:"So s√°nh S·∫£n l∆∞·ª£ng (kWh) H1 vs H2 trong ng√†y.",               color:"--c-prod" },
  runtime: { name:"T ch·∫°y m√°y",     hint:"So s√°nh T ch·∫°y m√°y (h) H1 vs H2 trong ng√†y.",                color:"--c-run" },
  H1_24:   { name:"H1 (24h)",       hint:"Bi·ªÉu ƒë·ªì c√¥ng su·∫•t 24h c·ªßa H1 (MW) trong ng√†y.",              color:"--c-h1p" },
  H2_24:   { name:"H2 (24h)",       hint:"Bi·ªÉu ƒë·ªì c√¥ng su·∫•t 24h c·ªßa H2 (MW) trong ng√†y.",              color:"--c-h2p" },
  A0_24:   { name:"NSMO (24h)",     hint:"Bi·ªÉu ƒë·ªì c√¥ng su·∫•t 24h NSMO (MW) trong ng√†y.",                  color:"--c-a0p" },
  MNH_7D:  { name:"MNH (D-7‚ÜíD-1)",  hint:"Bi·ªÉu ƒë·ªì MNH (m·ª±c n∆∞·ªõc h·ªì) t·ª´ D-7 ƒë·∫øn D-1.",                  color:"--c-mnh" },
  Q_7D:    { name:"Q (D-7‚ÜíD-1)",    hint:"Bi·ªÉu ƒë·ªì Q v·ªÅ, Q ch·∫°y v√† Q x·∫£ (m¬≥/s) D-7 ‚Üí D-1.",             color:"--c-qch" }
};

function metricBox(label, value, cls=""){
  const n = Number(value);
  const v = (value===null || value===undefined || value==="") ? "‚Äî" :
            (Number.isFinite(n) ? fmt.format(n) : String(value));
  return `
    <div class="metric ${cls}">
      <div class="mLabel">${label}</div>
      <div class="mVal">${v}</div>
    </div>
  `;
}

// ======================= DATA ACCESS =======================
async function testConnection(){
  const sb = getSupabase();
  const { error } = await sb.from("report_days").select("report_date").limit(1);
  if (error) throw error;
}

async function fetchDay(dayISO){
  const sb = getSupabase();

  const { data: dayArr, error: e1 } = await sb
    .from("report_days")
    .select("*")
    .eq("report_date", dayISO)
    .limit(1);
  if (e1) throw e1;
  const day = dayArr?.[0] || null;

  const { data: units, error: e2 } = await sb
    .from("report_units")
    .select("*")
    .eq("report_date", dayISO)
    .order("unit_code", { ascending:true });
  if (e2) throw e2;

  return { day, units: units || [] };
}

async function fetchRange(dayISO){
  const sb   = getSupabase();
  const from = addDaysISO(dayISO, -7);
  const to   = dayISO;
  const { data, error } = await sb
    .from("report_days")
    .select("report_date,q_ve_tb,q_chay_tb,q_xa,water_level")
    .gte("report_date", from)
    .lte("report_date", to)
    .order("report_date", { ascending:true });
  if (error) throw error;
  return data || [];
}

async function fetchPowerHourly(dayISO){
  const sb = getSupabase();
  const { data, error } = await sb
    .from("power_hourly")
    .select("hour,source,power_mw")
    .eq("report_date", dayISO)
    .order("hour", { ascending:true });

  if (error) throw error;
  return data || [];
}

function getUnit(units, code){
  return units.find(u=>u.unit_code === code) || null;
}

// ======================= COMMON RENDER =======================
function renderCommon(dayISO, day, h1, h2){
  $("basicTitle").textContent = dayISO ? `Ng√†y ${dayISO}` : "‚Äî";

  // --- S·∫¢N L∆Ø·ª¢NG NG√ÄY ---
  const e1src = h1?.sl_thuc_phat ?? h1?.energy_kwh;
  const e2src = h2?.sl_thuc_phat ?? h2?.energy_kwh;
  const e1 = Number(e1src);
  const e2 = Number(e2src);
  const has1 = Number.isFinite(e1);
  const has2 = Number.isFinite(e2);
  const esum = (has1?e1:0) + (has2?e2:0);

  $("eH1").textContent = has1 ? fmt0.format(e1) : "‚Äî";
  $("eH2").textContent = has2 ? fmt0.format(e2) : "‚Äî";
  $("eSum").textContent = (has1 || has2) ? fmt0.format(esum) : "‚Äî";
  $("eH1Sub").textContent = h1?.t_run != null ? `T: ${fmt.format(h1.t_run)} h` : "‚Äî";
  $("eH2Sub").textContent = h2?.t_run != null ? `T: ${fmt.format(h2.t_run)} h` : "‚Äî";

  // --- L≈®Y K·∫æ TH√ÅNG / NƒÇM ---
  const m1 = Number(h1?.lk_thang_kwh);
  const m2 = Number(h2?.lk_thang_kwh);
  const y1 = Number(h1?.lk_nam_kwh);
  const y2 = Number(h2?.lk_nam_kwh);
  const mSum = (Number.isFinite(m1)?m1:0) + (Number.isFinite(m2)?m2:0);
  const ySum = (Number.isFinite(y1)?y1:0) + (Number.isFinite(y2)?y2:0);

  $("eMonthTotal").textContent = mSum>0 ? fmt0.format(mSum) : "‚Äî";
  $("eMonthSub").innerHTML =
    `H1: <span class="h1v">${Number.isFinite(m1)?fmt0.format(m1):"‚Äî"}</span> ‚Ä¢ `+
    `H2: <span class="h2v">${Number.isFinite(m2)?fmt0.format(m2):"‚Äî"}</span>`;

  $("eYearTotal").textContent  = ySum>0 ? fmt0.format(ySum) : "‚Äî";
  $("eYearSub").innerHTML =
    `H1: <span class="h1v">${Number.isFinite(y1)?fmt0.format(y1):"‚Äî"}</span> ‚Ä¢ `+
    `H2: <span class="h2v">${Number.isFinite(y2)?fmt0.format(y2):"‚Äî"}</span>`;

  // --- SL ƒëƒÉng k√Ω, A0, QC t·ªïng H1+H2 ---
  const k1 = Number(h1?.sl_ke_hoach);
  const k2 = Number(h2?.sl_ke_hoach);
  const a1 = Number(h1?.sl_tu_khien ?? h1?.sl_a0_huy_dong);
  const a2 = Number(h2?.sl_tu_khien ?? h2?.sl_a0_huy_dong);
  const q1 = Number(h1?.sl_qc_thang12 ?? h1?.sl_qc_thang);
  const q2 = Number(h2?.sl_qc_thang12 ?? h2?.sl_qc_thang);

  const slKe = (Number.isFinite(k1)?k1:0) + (Number.isFinite(k2)?k2:0);
  const slA0 = (Number.isFinite(a1)?a1:0) + (Number.isFinite(a2)?a2:0);
  const slQc = (Number.isFinite(q1)?q1:0) + (Number.isFinite(q2)?q2:0);

  $("slKeHoach").textContent = (slKe>0) ? fmt0.format(slKe) : "‚Äî";
  $("slA0").textContent      = (slA0>0) ? fmt0.format(slA0) : "‚Äî";
  $("slQC").textContent      = (slQc>0) ? fmt0.format(slQc) : "‚Äî";

  // --- ƒêI·ªÜN T·ª∞ D√ôNG ---
  const s1 = Number(day?.td_h1);
  const s2 = Number(day?.td_h2);
  let sTotal = Number(day?.td_tong);
  if (!Number.isFinite(sTotal)) {
    sTotal = (Number.isFinite(s1)?s1:0) + (Number.isFinite(s2)?s2:0);
  }

  const hasSelf = sTotal > 0;
  $("eSelfTotal").textContent = hasSelf ? fmt0.format(sTotal) : "‚Äî";
  $("eSelfSub").innerHTML =
    `H1: <span class="h1v">${Number.isFinite(s1)?fmt0.format(s1):"‚Äî"}</span> ‚Ä¢ `+
    `H2: <span class="h2v">${Number.isFinite(s2)?fmt0.format(s2):"‚Äî"}</span>`;

  const ratio = Number(day?.td_tyle);
  $("selfRatio").textContent = Number.isFinite(ratio) ? fmt.format(ratio) : "‚Äî";
  $("selfRatioSub").textContent = "Tr√™n t·ªïng s·∫£n l∆∞·ª£ng ng√†y";

  // --- MNH ---
  const wl   = day?.water_level;
  const mnh  = day?.mnh_qt;
  const nsmo = day?.nsmo_tuan;
  $("basicMNH").textContent =
    (wl==null && mnh==null && nsmo==null) ? "‚Äî" :
    [wl,mnh,nsmo].map(v=>v==null?"‚Äî":fmt.format(v)).join(" / ");
  $("basicMNHSub").textContent = "M·ª±c n∆∞·ªõc h·ªì / MNH QT / NSMO";

  // --- Q ---
  const qv = day?.q_ve_tb;
  const qc = day?.q_chay_tb;
  const qx = day?.q_xa;

  if(qv==null && qc==null && qx==null){
    $("basicQ").textContent = "‚Äî";
  }else{
    const rgbVe = cssRGB("--c-qve");
    const rgbCh = cssRGB("--c-qch");
    const rgbXa = cssRGB("--c-qxa");
    const parts = [];
    if(qv!=null){
      parts.push(`<span class="qItem qVe"><span class="qDot"></span><span class="qLabel">Q v·ªÅ</span><span class="qNum" style="color:${rgba(rgbVe,0.95)}">${fmt.format(qv)}</span></span>`);
    }
    if(qc!=null){
      parts.push(`<span class="qItem qChay"><span class="qDot"></span><span class="qLabel">Q ch·∫°y</span><span class="qNum" style="color:${rgba(rgbCh,0.95)}">${fmt.format(qc)}</span></span>`);
    }
    if(qx!=null){
      parts.push(`<span class="qItem qXa"><span class="qDot"></span><span class="qLabel">Q x·∫£</span><span class="qNum" style="color:${rgba(rgbXa,0.95)}">${fmt.format(qx)}</span></span>`);
    }
    $("basicQ").innerHTML = `<div class="qValueWrap">${parts.join("")}</div>`;
  }
  $("basicQSub").textContent = "Q v·ªÅ / Q ch·∫°y / Q x·∫£";

  // --- M∆ØA & PH∆Ø∆†NG TH·ª®C ---
  const rainDay  = day?.rain_day;
  const rainYear = day?.rain_year;
  const rainStr =
    (rainDay==null && rainYear==null) ? "‚Äî" :
    `${rainDay!=null?fmt.format(rainDay):"‚Äî"} / ${rainYear!=null?fmt.format(rainYear):"‚Äî"} mm`;
  $("rainValue").textContent = rainStr;

  const phuongThuc = day?.phuong_thuc_ac || "‚Äî";
  $("rainSub").textContent = `M∆∞a ng√†y / M∆∞a nƒÉm ‚Ä¢ Ph∆∞∆°ng th·ª©c: ${phuongThuc}`;

  // --- PCT/phi·∫øu c√¥ng t√°c ---
  const workCount = day?.so_phieu_cong_tac;
  $("workValue").textContent = workCount!=null ? String(workCount) : "‚Äî";

  const daCap   = day?.pct_da_cap  || "";
  const daKhoa  = day?.pct_da_khoa || "";
  $("workSub").textContent = `ƒê√£ c·∫•p: ${daCap || "‚Äî"} ‚Ä¢ ƒê√£ kh√≥a: ${daKhoa || "‚Äî"}`;

  const lines = [];
  if(day?.note)        lines.push(String(day.note));
  if(daCap)            lines.push("PCT ƒë√£ c·∫•p: " + String(daCap));
  if(daKhoa)           lines.push("PCT ƒë√£ kh√≥a: " + String(daKhoa));
  $("basicNote").textContent = lines.length ? lines.join(" | ") : "‚Äî";
  $("noteText").textContent  = "Ghi ch√∫: " + (day?.note || "‚Äî");
}

function renderPlantCard(u){
  if(!u) return "";

  const unit = String(u.unit_code || "").toUpperCase();
  const cls = unit === "H1" ? "h1" : (unit === "H2" ? "h2" : "");
  const labelEnergy = "S·∫£n l∆∞·ª£ng (kWh)";

  return `
    <div class="plantCard ${cls}" style="margin-top:10px;">
      <div class="plantHead">
        <div class="name">üè≠ ${unit}</div>
        <span class="pill unit mono">${u.report_date}</span>
      </div>
      <div class="metrics">
        ${metricBox(labelEnergy,              u.sl_thuc_phat ?? u.energy_kwh, "u")}
        ${metricBox("T ch·∫°y (h)",            u.t_run, "u")}
        ${metricBox("Pmax (MW)",             u.p_max, "u")}
        ${metricBox("Pmin (MW)",             u.p_min, "u")}
        ${metricBox("AVC giao (kWh)",        u.avc_giao, "u")}
        ${metricBox("AVC nh·∫≠n (kWh)",        u.avc_nhan, "u")}
        ${metricBox("L≈©y k·∫ø th√°ng (kWh)",    u.lk_thang_kwh, "u")}
        ${metricBox("L≈©y k·∫ø nƒÉm (kWh)",      u.lk_nam_kwh, "u")}
        ${metricBox("Kh·ªüi ƒë·ªông ng√†y",        u.start_today, "u")}
        ${metricBox("Kh·ªüi ƒë·ªông l≈©y th√°ng",   u.start_month, "u")}
        ${metricBox("Kh·ªüi ƒë·ªông l≈©y nƒÉm",     u.start_year, "u")}
      </div>
    </div>
  `;
}

// ======================= CHARTS =======================
let currentTab     = "energy";
let chartInstance  = null;

let cache = {
  dayISO:null, day:null, units:null,
  rangeISO:null, rangeRows:null,
  powerISO:null, powerRows:null
};

function safeDestroyChart(){
  if(chartInstance && typeof chartInstance.destroy === "function"){
    chartInstance.destroy();
  }
  chartInstance = null;
}

function commonChartOptions(){
  return {
    responsive:true,
    maintainAspectRatio:false,
    interaction:{ mode:"index", intersect:false },
    plugins:{
      legend:{ labels:{ color:"rgba(231,236,255,.88)" } },
      tooltip:{
        callbacks:{
          label:(ctx)=>{
            const v = ctx.parsed.y;
            const t = Number.isFinite(v) ? fmt.format(v) : "‚Äî";
            return ` ${ctx.dataset.label}: ${t}`;
          }
        }
      }
    },
    scales:{
      x:{ ticks:{ color:"rgba(231,236,255,.7)" }, grid:{ color:"rgba(255,255,255,.07)" } },
      y:{ ticks:{ color:"rgba(231,236,255,.7)" }, grid:{ color:"rgba(255,255,255,.07)" } }
    }
  };
}

function makeChart(config){
  const ctx = $("chart").getContext("2d");
  safeDestroyChart();
  chartInstance = new Chart(ctx, config);
}

function chartCompareH1H2(dayISO, h1, h2, field, label, rgb){
  const v1src = h1 ? (field==="energy_kwh" ? (h1.sl_thuc_phat ?? h1.energy_kwh) : h1[field]) : null;
  const v2src = h2 ? (field==="energy_kwh" ? (h2.sl_thuc_phat ?? h2.energy_kwh) : h2[field]) : null;
  const v1 = Number(v1src);
  const v2 = Number(v2src);

  $("metricName").textContent = tabMeta[currentTab].name;
  $("chartHint").textContent  = `${label} ‚Ä¢ So s√°nh H1 vs H2 (ng√†y ${dayISO}).`;

  makeChart({
    type:"bar",
    data:{
      labels:["H1","H2"],
      datasets:[{
        label,
        data:[Number.isFinite(v1)?v1:null, Number.isFinite(v2)?v2:null],
        borderWidth:1.5,
        backgroundColor:[rgba(rgb,.35), rgba(rgb,.24)],
        borderColor:[rgba(rgb,.95), rgba(rgb,.7)]
      }]
    },
    options:commonChartOptions()
  });
}

async function ensureRangeLoaded(dayISO){
  if(cache.rangeISO === dayISO && cache.rangeRows) return;
  cache.rangeRows = await fetchRange(dayISO);
  cache.rangeISO  = dayISO;
}

async function ensurePowerLoaded(dayISO){
  if(cache.powerISO === dayISO && cache.powerRows) return;
  cache.powerRows = await fetchPowerHourly(dayISO);
  cache.powerISO  = dayISO;
}

function chartMNH(rows){
  const rgb    = cssRGB("--c-mnh");
  const labels = rows.map(r=>r.report_date);
  const data   = rows.map(r => {
    const n = Number(r.water_level);
    return Number.isFinite(n)?n:null;
  });

  $("metricName").textContent = tabMeta[currentTab].name;
  $("chartHint").textContent  = "MNH (m·ª±c n∆∞·ªõc h·ªì) ‚Ä¢ Xu h∆∞·ªõng D-7 ‚Üí D-1.";

  const opts = commonChartOptions();
  opts.plugins.tooltip.callbacks.label = (ctx)=>{
    const v = ctx.parsed.y;
    const t = Number.isFinite(v)?fmt.format(v):"‚Äî";
    return ` MNH: ${t} m`;
  };

  makeChart({
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"M·ª±c n∆∞·ªõc h·ªì (m)",
        data,
        spanGaps:true,
        tension:.35,
        borderWidth:2,
        borderColor:rgba(rgb,.96),
        backgroundColor:rgba(rgb,.24),
        pointRadius:3,
        pointHoverRadius:6,
        fill:true
      }]
    },
    options:opts
  });
}

function chartQ(rows){
  const rgbVe = cssRGB("--c-qve");
  const rgbCh = cssRGB("--c-qch");
  const rgbXa = cssRGB("--c-qxa");

  const labels = rows.map(r=>r.report_date);
  const dataVe = rows.map(r => Number.isFinite(Number(r.q_ve_tb)) ? Number(r.q_ve_tb) : null);
  const dataCh = rows.map(r => Number.isFinite(Number(r.q_chay_tb)) ? Number(r.q_chay_tb) : null);
  const dataXa = rows.map(r => Number.isFinite(Number(r.q_xa)) ? Number(r.q_xa) : null);

  $("metricName").textContent = tabMeta[currentTab].name;
  $("chartHint").textContent  = "Q v·ªÅ, Q ch·∫°y m√°y & Q x·∫£ (m¬≥/s) ‚Ä¢ Xu h∆∞·ªõng D-7 ‚Üí D-1.";

  const opts = commonChartOptions();
  opts.plugins.tooltip.callbacks.label = (ctx)=>{
    const v = ctx.parsed.y;
    const t = Number.isFinite(v)?fmt.format(v):"‚Äî";
    return ` ${ctx.dataset.label}: ${t} m¬≥/s`;
  };

  makeChart({
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Q v·ªÅ (m¬≥/s)", data:dataVe, spanGaps:true, tension:.35, borderWidth:2,
          borderColor:rgba(rgbVe,.96), backgroundColor:rgba(rgbVe,.18), pointRadius:3, pointHoverRadius:6, fill:true
        },
        { label:"Q ch·∫°y m√°y (m¬≥/s)", data:dataCh, spanGaps:true, tension:.35, borderWidth:2,
          borderColor:rgba(rgbCh,.96), backgroundColor:rgba(rgbCh,.18), pointRadius:3, pointHoverRadius:6, fill:true
        },
        { label:"Q x·∫£ (m¬≥/s)", data:dataXa, spanGaps:true, tension:.35, borderWidth:2,
          borderColor:rgba(rgbXa,.96), backgroundColor:rgba(rgbXa,.18), pointRadius:3, pointHoverRadius:6, fill:true
        }
      ]
    },
    options:opts
  });
}

function chartPower24(dayISO, powerRows, source, seriesLabel, rgb){
  const labels = Array.from({length:24}, (_,i)=> String(i+1));
  const byHour = new Map();
  for (const r of powerRows){
    if (String(r.source).toUpperCase() !== source) continue;
    const h = Number(r.hour);
    const v = Number(r.power_mw);
    if (Number.isFinite(h) && h>=1 && h<=24) byHour.set(h, Number.isFinite(v) ? v : null);
  }
  const data = labels.map((_,i)=> byHour.get(i+1) ?? null);

  $("metricName").textContent = tabMeta[currentTab].name;
  $("chartHint").textContent  = `${seriesLabel} (MW) theo gi·ªù ‚Ä¢ Ng√†y ${dayISO}.`;

  const opts = commonChartOptions();
  opts.plugins.tooltip.callbacks.label = (ctx)=>{
    const v = ctx.parsed.y;
    const t = Number.isFinite(v)?fmt.format(v):"‚Äî";
    return ` ${seriesLabel}: ${t} MW`;
  };

  makeChart({
    type:"line",
    data:{
      labels,
      datasets:[{
        label: seriesLabel + " (MW)",
        data,
        spanGaps:true,
        tension:.32,
        borderWidth:2,
        borderColor:rgba(rgb,.95),
        backgroundColor:rgba(rgb,.18),
        pointRadius:3,
        pointHoverRadius:6,
        fill:true
      }]
    },
    options:opts
  });
}

async function renderChart(dayISO, day, units){
  const h1   = getUnit(units,"H1");
  const h2   = getUnit(units,"H2");
  const meta = tabMeta[currentTab];
  $("tabHint").textContent = meta.hint;
  const rgb = cssRGB(meta.color);

  if(currentTab === "energy"){
    return chartCompareH1H2(dayISO, h1, h2, "energy_kwh", "S·∫£n l∆∞·ª£ng (kWh)", rgb);
  }
  if(currentTab === "runtime"){
    return chartCompareH1H2(dayISO, h1, h2, "t_run", "T ch·∫°y m√°y (h)", rgb);
  }

  if(currentTab === "H1_24" || currentTab === "H2_24" || currentTab === "A0_24"){
    await ensurePowerLoaded(dayISO);
    const rows = cache.powerRows || [];

    if(!rows.length){
      $("metricName").textContent = tabMeta[currentTab].name;
      $("chartHint").textContent = `Kh√¥ng c√≥ d·ªØ li·ªáu power_hourly cho ng√†y ${dayISO}.`;
      safeDestroyChart();
      return;
    }

    if(currentTab === "H1_24") return chartPower24(dayISO, rows, "H1", "H1", rgb);
    if(currentTab === "H2_24") return chartPower24(dayISO, rows, "H2", "H2", rgb);
    if(currentTab === "A0_24") return chartPower24(dayISO, rows, "A0", "A0", rgb);
  }

  await ensureRangeLoaded(dayISO);
  const rows = cache.rangeRows || [];
  if(currentTab === "MNH_7D"){
    return chartMNH(rows);
  }
  if(currentTab === "Q_7D"){
    return chartQ(rows);
  }
}

// ======================= LOAD + UI =======================
async function loadDay(){
  const dayISO = $("day").value;
  $("dateText").textContent = dayISO || "‚Äî";
  if(!dayISO){
    toast("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£");
    return;
  }

  $("btnLoad").disabled = true;
  $("detailWrap").innerHTML = `<div class="empty">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>`;
  safeDestroyChart();

  try{
    const { day, units } = await fetchDay(dayISO);
    cache.dayISO = dayISO;
    cache.day    = day;
    cache.units  = units;

    cache.powerISO = null;
    cache.powerRows = null;

    const h1 = getUnit(units,"H1");
    const h2 = getUnit(units,"H2");

    if(!day && (!h1 && !h2)){
      $("detailWrap").innerHTML = `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†y n√†y.</div>`;
      toast("Ng√†y n√†y ch∆∞a c√≥ d·ªØ li·ªáu");
      return;
    }

    renderCommon(dayISO, day, h1, h2);

    const view = $("view").value;
    let html = "";
    if(view === "BOTH"){
      html = renderPlantCard(h1) + renderPlantCard(h2);
    }else if(view === "H1"){
      html = renderPlantCard(h1) || `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu H1 cho ng√†y n√†y.</div>`;
    }else{
      html = renderPlantCard(h2) || `<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu H2 cho ng√†y n√†y.</div>`;
    }
    $("detailWrap").innerHTML = html;

    await renderChart(dayISO, day, units);
    toast("ƒê√£ t·∫£i d·ªØ li·ªáu");
  }catch(e){
    console.error("loadDay error", e);
    $("detailWrap").innerHTML =
      `<div class="empty">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: <span class="mono">${e.message || String(e)}</span></div>`;
    safeDestroyChart();
    toast("L·ªói t·∫£i d·ªØ li·ªáu");
  }finally{
    $("btnLoad").disabled = false;
  }
}

// ======================= INIT =======================
window.addEventListener("load", async ()=>{
  $("day").value = getDMinus1ISO();
  $("dateText").textContent = $("day").value;

  setConn("", "ƒêang ki·ªÉm tra Supabase‚Ä¶");
  try{
    await testConnection();
    setConn("ok","K·∫øt n·ªëi OK");
  }catch(e){
    console.error("testConnection error", e);
    setConn("err","L·ªói k·∫øt n·ªëi / RLS: " + (e.message || ""));
    toast("Ki·ªÉm tra RLS / anon key");
  }

  await loadDay();
});

$("btnLoad").addEventListener("click", loadDay);
$("day").addEventListener("change", loadDay);
$("view").addEventListener("change", loadDay);

$("metricTabs").addEventListener("click", async (e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  currentTab = t.dataset.m;

  const meta = tabMeta[currentTab];
  $("metricName").textContent = meta.name;
  $("tabHint").textContent    = meta.hint;

  const dayISO = $("day").value;
  if(!dayISO) return;
  try{
    if(cache.dayISO === dayISO){
      await renderChart(dayISO, cache.day, cache.units || []);
    }else{
      await loadDay();
    }
    toast(`Bi·ªÉu ƒë·ªì: ${meta.name}`);
  }catch(err){
    console.error("metricTabs chart error", err);
    safeDestroyChart();
    toast("Kh√¥ng v·∫Ω ƒë∆∞·ª£c bi·ªÉu ƒë·ªì");
  }
});
</script>

  <!-- Service Worker ƒëƒÉng k√Ω PWA -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
          .then(() => console.log("SW OK"))
          .catch(err => console.log("SW l·ªói:", err));
      });
    }
  </script>
</body>
</html>
